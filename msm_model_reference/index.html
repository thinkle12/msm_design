<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Msm Model - Test Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Msm Model";
        var mkdocs_page_input_path = "msm_model_reference.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Test Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Code Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Msm Model</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#msm_design">msm_design</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#msm_design.msm_model">msm_model</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#msm_design.msm_model.SGD_Online">SGD_Online</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#msm_design.msm_model.SGD_Online.__init__">__init__()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#msm_design.msm_model.SGD_Static">SGD_Static</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#msm_design.msm_model.pair_select">pair_select()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#msm_design.msm_model.score_sequence_amber">score_sequence_amber()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#msm_design.msm_model.sigma2Phi">sigma2Phi()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#msm_design.msm_optimization">msm_optimization</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#msm_design.msm_optimization.Sequence_Optimization">Sequence_Optimization</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#msm_design.msm_optimization.Sequence_Optimization.generate_seq_energy">generate_seq_energy()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#msm_design.msm_optimization.Sequence_Optimization.single_state_design">single_state_design()</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Test Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Code Reference &raquo;</li><li>Msm Model</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="msm-model-module">msm model module</h1>


  <div class="doc doc-object doc-module">

<a id="msm_design"></a>
    <div class="doc doc-contents first">

      <p>Created on Tue Oct 10 22:38:13 2017</p>
<p>@author: Trent</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="msm_design.msm_model">
        <code>msm_model</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 class="doc doc-heading" id="msm_design.msm_model.SGD_Online">
        <code>
SGD_Online        </code>



</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>msm_design/msm_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SGD_Online</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wt_seq</span><span class="p">,</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">sequence_alignment_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reduce_alignment</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">output_energy_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">custom_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pair_select_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pair_dist</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">gamma_multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">regular_linear_regression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">lasso</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lambda_lasso_coef</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">ridge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">ridge_coef</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">output_cc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">output_mad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">rosetta_score_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/source/bin/&#39;</span><span class="p">,</span>
                 <span class="n">rosetta_database_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/database&#39;</span><span class="p">):</span>


        <span class="s1">&#39;Takes in a pdb file, sequence alignment file, wild type sequence, and energy scoring script&#39;</span>
        <span class="s1">&#39;We provide two scoring scripts score_sequence_amber.py and score_sequence_rosetta.py&#39;</span>
        <span class="s1">&#39;The rosetta script requires rosetta protein structure software&#39;</span>
        <span class="s1">&#39;The amber script requires openmm molecular modeling software as well as rosetta for energy minimization&#39;</span>
        <span class="s1">&#39;this class must run in command line to make use of energy scoring scripts which output energies to command line&#39;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pdbfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span> <span class="o">=</span> <span class="n">pair_select_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span> <span class="o">=</span> <span class="n">gamma_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span> <span class="o">=</span> <span class="n">wt_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="o">=</span> <span class="n">regular_linear_regression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="o">=</span> <span class="n">lasso</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span> <span class="o">=</span> <span class="n">ridge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_lasso_coef</span> <span class="o">=</span> <span class="n">lambda_lasso_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridge_coef</span> <span class="o">=</span> <span class="n">ridge_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_energy_file</span> <span class="o">=</span> <span class="n">output_energy_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_cc</span> <span class="o">=</span> <span class="n">output_cc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_mad</span> <span class="o">=</span> <span class="n">output_mad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span> <span class="o">=</span> <span class="n">custom_tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overall_solution_space</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CC</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAD</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_parameters</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span> <span class="o">=</span> <span class="n">reduce_alignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_dist</span><span class="o">=</span><span class="n">pair_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="o">=</span><span class="n">sequence_alignment_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_score_path</span> <span class="o">=</span> <span class="n">rosetta_score_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_database_path</span> <span class="o">=</span> <span class="n">rosetta_database_path</span>


    <span class="k">def</span> <span class="nf">online_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">energy_scoring_function</span><span class="o">=</span><span class="s1">&#39;rosetta&#39;</span><span class="p">,</span><span class="n">num_mutations</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">max_computation_time</span><span class="o">=</span><span class="mi">252000</span><span class="p">,</span><span class="n">max_training_sets</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span><span class="n">mad_cutoff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">w_start_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#Scoring function is either &#39;rosetta&#39; or &#39;amber&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No model type selected, one of regular_linear_regression, lasso, or ridge must be true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use both regular and lasso regression, select one or the other&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use both regular and ridge regression, select one or the other&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use both ridge and lasso regression, select one or the other&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use regular, ridge, and lasso regression at the same time, select one or the other&#39;</span><span class="p">)</span>



        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>



        <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_computation_time</span>

        <span class="k">if</span> <span class="n">w_start_file</span><span class="p">:</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">w_start_file</span><span class="p">,</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">newtext</span> <span class="o">=</span> <span class="n">hh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">newtext</span> <span class="o">=</span> <span class="n">newtext</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">newtext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">numbers</span> <span class="ow">in</span> <span class="n">newtext</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">numbers</span><span class="p">))</span>


        <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
        <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>

        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">)</span>

        <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">)</span>

        <span class="n">trainingsets</span> <span class="o">=</span> <span class="n">max_training_sets</span>
        <span class="n">madcutoff</span> <span class="o">=</span> <span class="n">mad_cutoff</span>


        <span class="c1">#Here Creating the tag that follows to output files...</span>
        <span class="c1">#This is skipped if a custom_tag variable is defined</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">:</span>
                <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">:</span>
                <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span><span class="p">:</span>
             <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filename Tag will be = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_energy_file</span><span class="p">:</span>
            <span class="n">seqEfilename</span> <span class="o">=</span> <span class="s1">&#39;ubiquitin_energies_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span>





         <span class="c1"># the length of the protein</span>




        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span><span class="p">:</span>
            <span class="n">position_pairs</span> <span class="o">=</span> <span class="n">pair_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_dist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position_pairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#Definitions</span>

        <span class="c1"># Sample a random sequence, evaluate its energy according to our energy fucntion, and store the sequence and energy data</span>


        <span class="n">E_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">MAD</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Philist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stochastic Gradient Descent&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# of pair interactions = </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> maximum training sequences, gamma = </span><span class="si">%s</span><span class="s1">/((i+1)**0.5)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position_pairs</span><span class="p">),</span><span class="n">trainingsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_energy_file</span><span class="p">:</span>    
            <span class="nb">open</span><span class="p">(</span><span class="n">seqEfilename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_cc</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_mad</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;MAD&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trainingsets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="o">&lt;</span><span class="n">max_time</span><span class="p">:</span>
                <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
                <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
                <span class="n">randAAlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_mutations</span><span class="p">):</span>
                    <span class="n">randAAlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">mutantpositions</span> <span class="ow">in</span> <span class="n">randAAlist</span><span class="p">:</span>
                    <span class="n">wtlist</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">])</span>
                <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wtlist</span><span class="p">)</span>

                <span class="c1">#cmd = &#39;python &#39;+str(self.energy_scoring_script)+&#39; %s&#39; % random_seq #1. generate a terminal command as a string</span>
                <span class="c1">#output = Popen(cmd,shell=True,stdout=PIPE).communicate() #2. send the command to the terminal shell</span>
                <span class="c1">#seq_E = float(output[0]) #3. read the result and convert to a float</span>

                <span class="s1">&#39;Add a new energy scoring function here if wanted&#39;</span>
                <span class="s1">&#39;Input should be random_seq and an associated pdbfile&#39;</span>
                <span class="s1">&#39;Should create a definition similar to the two energy function definitions provided&#39;</span>
                <span class="s1">&#39;if there is a need or want for a different energy function&#39;</span> 
                <span class="k">if</span> <span class="n">energy_scoring_function</span><span class="o">==</span><span class="s1">&#39;amber&#39;</span><span class="p">:</span>
                    <span class="n">seq_E</span> <span class="o">=</span> <span class="n">score_sequence_amber</span><span class="p">(</span><span class="n">random_seq</span><span class="p">,</span><span class="n">pdbfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">,</span>
                                                   <span class="n">rosetta_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_score_path</span><span class="p">,</span>
                                                   <span class="n">rosetta_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_database_path</span><span class="p">)</span>          

                <span class="k">if</span> <span class="n">energy_scoring_function</span><span class="o">==</span><span class="s1">&#39;rosetta&#39;</span><span class="p">:</span>
                    <span class="n">seq_E</span> <span class="o">=</span> <span class="n">score_sequence_rosetta</span><span class="p">(</span><span class="n">random_seq</span><span class="p">,</span><span class="n">pdbfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">,</span>
                                                   <span class="n">rosetta_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_score_path</span><span class="p">,</span>
                                                   <span class="n">rosetta_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_database_path</span><span class="p">)</span>          


                <span class="c1">#This bypasses Amber not returning scores for certain sequences</span>
                <span class="k">if</span> <span class="n">seq_E</span><span class="o">==</span><span class="s1">&#39;Nan&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sequence did not generate a score&#39;</span><span class="p">)</span>
                    <span class="k">pass</span>                

                <span class="k">if</span> <span class="n">seq_E</span><span class="o">!=</span><span class="s1">&#39;Nan&#39;</span><span class="p">:</span>
                    <span class="c1">#print(seq_E)</span>
                    <span class="n">seq_E</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">seq_E</span><span class="p">)</span> <span class="c1">#3. read the result and convert to a float</span>




                    <span class="nb">print</span><span class="p">(</span><span class="n">random_seq</span><span class="p">,</span> <span class="n">seq_E</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_energy_file</span><span class="p">:</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">seqEfilename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">random_seq</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">seq_E</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_E</span><span class="p">)</span>
                    <span class="c1">#Convert Seq to Phi Here</span>
                    <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
                        <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">sigma2Phi</span><span class="p">(</span><span class="n">random_seq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                        <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">position_pairs</span><span class="p">:</span>
                            <span class="n">firstpos</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">secondpos</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">pairs_j</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">(</span><span class="n">random_seq</span><span class="p">[</span><span class="n">firstpos</span><span class="p">],</span><span class="n">random_seq</span><span class="p">[</span><span class="n">secondpos</span><span class="p">],</span><span class="n">firstpos</span><span class="p">,</span><span class="n">secondpos</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                            <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pairs_j</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">:</span>
                        <span class="n">Philist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_Phi</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_Phi</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">w_start_file</span><span class="p">:</span>
                                <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#Starting vector for regular regression not L1</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Phi_i</span><span class="o">*</span><span class="n">L</span><span class="p">)):</span>
                                        <span class="n">w</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.01</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Variables in Model = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;=</span><span class="mi">100</span><span class="p">:</span>
                        <span class="n">Philist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_Phi</span><span class="p">)</span>
                        <span class="n">trainPhi</span> <span class="o">=</span> <span class="n">Philist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">Philist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">E_testinglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">E_list</span><span class="p">[</span><span class="o">-</span><span class="n">xx</span><span class="p">]</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">)]</span>
                        <span class="n">E_testinglist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                        <span class="n">trainE</span> <span class="o">=</span> <span class="n">E_list</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">E_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>

                        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span><span class="o">/</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># have to do plus one cause first round i = 0</span>

                        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trainPhi</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># column vector</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">weight</span> <span class="o">-</span> <span class="n">trainE</span><span class="o">*</span><span class="n">weight</span><span class="p">)</span>
                        <span class="c1">#Ridge</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">weight</span> <span class="o">-</span> <span class="n">trainE</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge_coef</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
                        <span class="c1">#Lasso</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">weight</span> <span class="o">-</span> <span class="n">trainE</span><span class="o">*</span><span class="n">weight</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                                <span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">STF</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">gamma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_lasso_coef</span><span class="p">)</span>


                        <span class="n">E_estimate</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">Philist</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Philist</span><span class="p">)):</span>
                            <span class="n">E_estimate</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Philist</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="n">w</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">E_estimate</span> <span class="o">=</span> <span class="n">E_estimate</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">cc</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">E_testinglist</span><span class="p">,</span><span class="n">E_estimate</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mad</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">E_estimate</span><span class="o">-</span><span class="n">E_testinglist</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cc = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mad = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mad</span><span class="p">))</span>
                        <span class="n">CC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="c1"># calculate the correlation coeffcient, append into list</span>
                        <span class="n">MAD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mad</span><span class="p">)</span><span class="c1"># calculate the mean absolute deviation, append into list</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_cc</span><span class="p">:</span>
                            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_mad</span><span class="p">:</span>
                            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;MAD&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mad</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">madlist100</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">100</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">):</span>
                                <span class="n">madlist100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MAD</span><span class="p">[</span><span class="o">-</span><span class="n">g</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">mm</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">(</span><span class="n">madcutoff</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">madlist100</span><span class="p">):</span>
                                <span class="k">break</span>

        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1">#open(&#39;wState0.txt&#39;,&#39;w&#39;)</span>
        <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)):</span>
            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">vv</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CC</span><span class="o">=</span><span class="n">CC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAD</span><span class="o">=</span><span class="n">MAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_parameters</span><span class="o">=</span><span class="n">w</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;energy function fit:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">CC = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">CC</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">MAD = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MAD</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1">#plt.scatter(E_testinglist,E_estimate)</span>
        <span class="c1">#plt.show()</span>




        <span class="c1">#Test to see how many features are zero...</span>
        <span class="n">zerolist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">zerolist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Features Equal to Zero in the Model = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">zerolist</span><span class="p">))</span>

        <span class="n">elapsedtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elapsedtime</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 class="doc doc-heading" id="msm_design.msm_model.SGD_Online.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wt_seq</span><span class="p">,</span> <span class="n">pdbfile</span><span class="p">,</span> <span class="n">sequence_alignment_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reduce_alignment</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">output_energy_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">custom_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pair_select_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pair_dist</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">gamma_multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">regular_linear_regression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lasso</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lambda_lasso_coef</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">ridge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ridge_coef</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">output_cc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_mad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rosetta_score_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/source/bin/&#39;</span><span class="p">,</span> <span class="n">rosetta_database_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/database&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Takes in a pdb file, sequence alignment file, wild type sequence, and energy scoring script</p>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wt_seq</span><span class="p">,</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">sequence_alignment_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reduce_alignment</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">output_energy_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">custom_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pair_select_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pair_dist</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">gamma_multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
             <span class="n">regular_linear_regression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">lasso</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lambda_lasso_coef</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">ridge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">ridge_coef</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">output_cc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">output_mad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">rosetta_score_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/source/bin/&#39;</span><span class="p">,</span>
             <span class="n">rosetta_database_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/database&#39;</span><span class="p">):</span>


    <span class="s1">&#39;Takes in a pdb file, sequence alignment file, wild type sequence, and energy scoring script&#39;</span>
    <span class="s1">&#39;We provide two scoring scripts score_sequence_amber.py and score_sequence_rosetta.py&#39;</span>
    <span class="s1">&#39;The rosetta script requires rosetta protein structure software&#39;</span>
    <span class="s1">&#39;The amber script requires openmm molecular modeling software as well as rosetta for energy minimization&#39;</span>
    <span class="s1">&#39;this class must run in command line to make use of energy scoring scripts which output energies to command line&#39;</span>        
    <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pdbfile</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span> <span class="o">=</span> <span class="n">pair_select_list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span> <span class="o">=</span> <span class="n">gamma_multiplier</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span> <span class="o">=</span> <span class="n">wt_seq</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="o">=</span> <span class="n">regular_linear_regression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="o">=</span> <span class="n">lasso</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span> <span class="o">=</span> <span class="n">ridge</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lambda_lasso_coef</span> <span class="o">=</span> <span class="n">lambda_lasso_coef</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ridge_coef</span> <span class="o">=</span> <span class="n">ridge_coef</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_energy_file</span> <span class="o">=</span> <span class="n">output_energy_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_cc</span> <span class="o">=</span> <span class="n">output_cc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_mad</span> <span class="o">=</span> <span class="n">output_mad</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span> <span class="o">=</span> <span class="n">custom_tag</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overall_solution_space</span><span class="o">=</span><span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">CC</span><span class="o">=</span><span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">MAD</span><span class="o">=</span><span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_parameters</span><span class="o">=</span><span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span> <span class="o">=</span> <span class="n">reduce_alignment</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pair_dist</span><span class="o">=</span><span class="n">pair_dist</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="o">=</span><span class="n">sequence_alignment_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_score_path</span> <span class="o">=</span> <span class="n">rosetta_score_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_database_path</span> <span class="o">=</span> <span class="n">rosetta_database_path</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 class="doc doc-heading" id="msm_design.msm_model.SGD_Static">
        <code>
SGD_Static        </code>



</h3>

    <div class="doc doc-contents ">

      <p>Test header</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>scored</code></td>
        <td><code>bool</code></td>
        <td><p>test score arg</p></td>
      </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p><code>list</code> – test list return</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">SGD_Static</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SGD_Static</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test header</span>

<span class="sd">    Attributes:</span>
<span class="sd">        scored (bool): test score arg</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: test list return</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; data = SGD_Static()</span>
<span class="sd">        &gt;&gt;&gt; output = data.do_something()</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">sequence_energy_file</span><span class="p">,</span><span class="n">wt_seq</span><span class="p">,</span><span class="n">sequence_alignment_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reduce_alignment</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pair_select_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pair_dist</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">gamma_multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">regular_linear_regression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">lasso</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lambda_lasso_coef</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">ridge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ridge_coef</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">custom_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pdbfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_energy_file</span> <span class="o">=</span> <span class="n">sequence_energy_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span> <span class="o">=</span> <span class="n">sequence_alignment_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span> <span class="o">=</span> <span class="n">pair_select_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span> <span class="o">=</span> <span class="n">gamma_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span> <span class="o">=</span> <span class="n">wt_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="o">=</span> <span class="n">regular_linear_regression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="o">=</span> <span class="n">lasso</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span> <span class="o">=</span> <span class="n">ridge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_lasso_coef</span> <span class="o">=</span> <span class="n">lambda_lasso_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridge_coef</span> <span class="o">=</span> <span class="n">ridge_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span> <span class="o">=</span> <span class="n">custom_tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overall_solution_space</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CC</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAD</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_parameters</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_dist</span><span class="o">=</span><span class="n">pair_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="o">=</span><span class="n">reduce_alignment</span>



    <span class="k">def</span> <span class="nf">static_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mad_thresh</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span><span class="n">model_output_text_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">display_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No model type selected, one of regular_linear_regression, lasso, or ridge must be true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use both regular and lasso regression, select one or the other&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use both regular and ridge regression, select one or the other&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use both ridge and lasso regression, select one or the other&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use regular, ridge, and lasso regression at the same time, select one or the other&#39;</span><span class="p">)</span>



        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="c1">#max_time = 252000</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="mi">5000000</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">:</span>
                <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">:</span>
                <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span><span class="p">:</span>
             <span class="n">pdbtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_tag</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filename Tag will be = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">))</span>


        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span> <span class="c1"># the length of the protein</span>


        <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">)</span>

        <span class="c1">#wildtype = &#39;MQIFVKTLTGKTITLEVEPSDTIENVKAKIQDKEGIPPDQQRLIFAGKQLEDGRTLSDYNIQKESTLHLVLRLRGG&#39;</span>
        <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
        <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>


        <span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_energy_file</span><span class="p">,</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="p">]</span>
        <span class="n">Energies</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">=</span><span class="n">sequences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">=</span><span class="n">Energies</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span><span class="p">:</span>
            <span class="n">position_pairs</span> <span class="o">=</span> <span class="n">pair_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_dist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position_pairs</span> <span class="o">=</span> <span class="p">[]</span>







        <span class="c1"># Sample a random sequence, evaluate its energy according to our energy fucntion, and store the sequence and energy data</span>
        <span class="n">trainingsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Energies</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of training sets = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Energies</span><span class="p">)))</span>

        <span class="n">E_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">random_Seq_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">MAD</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#w = []</span>
        <span class="n">Philist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trainE</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trainPhi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stochastic Gradient Descent Multivariate Linear Regression&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# of pair interactions = </span><span class="si">%s</span><span class="s1">, gamma = </span><span class="si">%s</span><span class="s1">/((i+1)**0.5)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position_pairs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>



        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trainingsets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="o">&lt;</span><span class="n">max_time</span><span class="p">:</span>
                <span class="n">random_Seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequences</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="n">E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Energies</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

                <span class="c1">#Convert Seq to Phi Here</span>
                <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
                    <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">sigma2Phi</span><span class="p">(</span><span class="n">random_Seq_list</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                    <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair_select_list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">position_pairs</span><span class="p">:</span>
                        <span class="n">firstpos</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">secondpos</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">pairs_j</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">(</span><span class="n">random_Seq_list</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">firstpos</span><span class="p">],</span><span class="n">random_Seq_list</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">secondpos</span><span class="p">],</span><span class="n">firstpos</span><span class="p">,</span><span class="n">secondpos</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                        <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pairs_j</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">:</span>
                    <span class="n">Philist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_Phi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_Phi</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#Starting vector for regular regression not L1</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Phi_i</span><span class="o">*</span><span class="n">L</span><span class="p">)):</span>
                                <span class="n">w</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.01</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Variables in Model = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">&gt;=</span><span class="mi">100</span><span class="p">:</span>
                    <span class="n">Philist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_Phi</span><span class="p">)</span>
                    <span class="n">trainPhi</span> <span class="o">=</span> <span class="n">Philist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">Philist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">E_testinglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">E_list</span><span class="p">[</span><span class="o">-</span><span class="n">xx</span><span class="p">]</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">)]</span>
                    <span class="n">E_testinglist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">trainE</span> <span class="o">=</span> <span class="n">E_list</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_multiplier</span><span class="o">/</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">100</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>


                    <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trainPhi</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># column vector</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_linear_regression</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">weight</span> <span class="o">-</span> <span class="n">trainE</span><span class="o">*</span><span class="n">weight</span><span class="p">)</span>
                    <span class="c1">#Ridge</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">weight</span> <span class="o">-</span> <span class="n">trainE</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge_coef</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
                    <span class="c1">#Lasso</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">weight</span> <span class="o">-</span> <span class="n">trainE</span><span class="o">*</span><span class="n">weight</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                            <span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">STF</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">gamma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_lasso_coef</span><span class="p">)</span>

                    <span class="c1"># analyze the fit of the current model w</span>
                    <span class="c1">#Regular Matrix Multiplication</span>
                    <span class="n">E_estimate</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">Philist</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Philist</span><span class="p">)):</span>
                        <span class="n">E_estimate</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Philist</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="n">w</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">E_estimate</span> <span class="o">=</span> <span class="n">E_estimate</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cc</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">E_testinglist</span><span class="p">,</span><span class="n">E_estimate</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">mad</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">E_estimate</span><span class="o">-</span><span class="n">E_testinglist</span><span class="p">))</span>
                    <span class="n">CC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="c1"># calculate the correlation coeffcient, append into list</span>
                    <span class="n">MAD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mad</span><span class="p">))</span><span class="c1"># calculate the mean absolute deviation, append into list</span>
                    <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Training set = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#This prints the current training set index on same line as an update</span>
                    <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="n">madlist100</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">100</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">):</span>
                            <span class="n">madlist100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MAD</span><span class="p">[</span><span class="o">-</span><span class="n">g</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">mm</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">(</span><span class="n">mad_thresh</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">madlist100</span><span class="p">):</span>
                            <span class="k">break</span>

        <span class="k">if</span> <span class="n">model_output_text_file</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)):</span>
                <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pdbtag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">vv</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>             


        <span class="bp">self</span><span class="o">.</span><span class="n">CC</span><span class="o">=</span><span class="n">CC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAD</span><span class="o">=</span><span class="n">MAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_parameters</span><span class="o">=</span><span class="n">w</span>
        <span class="k">if</span> <span class="n">display_plots</span><span class="p">:</span>  
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">)),</span><span class="n">MAD</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CC</span><span class="p">)),</span><span class="n">CC</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_testinglist</span><span class="p">,</span><span class="n">E_estimate</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;energy function fit:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">CC = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">CC</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">MAD = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MAD</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">MAD</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1">#Test to see how many features are zero...</span>
        <span class="n">zerolist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">zerolist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Features Equal to Zero in the Model = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">zerolist</span><span class="p">))</span>

        <span class="n">sumlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="n">sumlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MAD</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Avg MAD of last 1000 terms = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sumlist</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>

        <span class="n">elapsedtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elapsedtime</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>






  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="msm_design.msm_model.pair_select">
<code class="highlight language-python"><span class="n">pair_select</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">wt_seq</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Here we select the maximum distance for a pair of AAs to be considered important</p>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pair_select</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">wt_seq</span><span class="p">):</span>
    <span class="s2">&quot;Here we select the maximum distance for a pair of AAs to be considered important&quot;</span>
    <span class="n">angstrom_distance</span> <span class="o">=</span> <span class="n">dist</span>
    <span class="c1">#########################################################################</span>
    <span class="c1">#this should really use the &#39;state&#39; pdb files....</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wt_seq</span><span class="p">)</span>





    <span class="c1">#AAs = [&#39;A&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;, &#39;H&#39;,&#39;I&#39;, &#39;K&#39;, &#39;L&#39;, &#39;M&#39;, &#39;N&#39;, &#39;P&#39;, &#39;Q&#39;, &#39;R&#39;, &#39;S&#39;, &#39;T&#39;, &#39;V&#39;, &#39;W&#39;,&#39;Y&#39;] #all 20 amino acids</span>



    <span class="n">pdbdata</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">pdblines</span> <span class="o">=</span> <span class="n">pdbdata</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdblines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;ATOM&#39;</span><span class="p">:</span>
            <span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1">#&quot;Why is there a lot of extra sequences in the pdb file&quot;</span>
    <span class="c1">#for i in range(4123):</span>
    <span class="c1">#    coordinates.pop()</span>

    <span class="s2">&quot;Here we make lists of all atoms x,y,z coordinates and pair them by which AA they are in into lists, each list corresponds to the atoms in each AA&quot;</span>
    <span class="n">xcoors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">xcoors</span><span class="p">[</span><span class="s1">&#39;AAxcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span><span class="o">==</span><span class="n">j</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]</span>
                <span class="n">xnum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">xcoors</span><span class="p">[</span><span class="s1">&#39;AAxcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xnum</span><span class="p">)</span>

    <span class="n">ycoors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">ycoors</span><span class="p">[</span><span class="s1">&#39;AAycoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span><span class="o">==</span><span class="n">k</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]</span>
                <span class="n">ynum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">ycoors</span><span class="p">[</span><span class="s1">&#39;AAycoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ynum</span><span class="p">)</span>

    <span class="n">zcoors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">zcoors</span><span class="p">[</span><span class="s1">&#39;AAzcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span><span class="o">==</span><span class="n">s</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span>
                <span class="n">znum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="n">zcoors</span><span class="p">[</span><span class="s1">&#39;AAzcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">znum</span><span class="p">)</span>


    <span class="s2">&quot;Pair all xyz together&quot;</span>
    <span class="n">listofxyz</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">listofxyz</span><span class="p">[</span><span class="s1">&#39;listofxyz&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="s2">&quot;XYZ points of all atoms sorted into lists of corresponding AAs&quot;</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xcoors</span><span class="p">[</span><span class="s1">&#39;AAxcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)])):</span>
            <span class="n">listofxyz</span><span class="p">[</span><span class="s1">&#39;listofxyz&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xcoors</span><span class="p">[</span><span class="s1">&#39;AAxcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)][</span><span class="n">j</span><span class="p">],</span><span class="n">ycoors</span><span class="p">[</span><span class="s1">&#39;AAycoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)][</span><span class="n">j</span><span class="p">],</span><span class="n">zcoors</span><span class="p">[</span><span class="s1">&#39;AAzcoor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)][</span><span class="n">j</span><span class="p">]))</span>

    <span class="s2">&quot;Here we find the distance between every atom in the protein separated by the atoms that belong to specific AAs&quot;</span>
    <span class="n">atomtoatom</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">j</span><span class="p">:</span>
                <span class="n">atomtoatom</span><span class="p">[</span><span class="s1">&#39;atomtoatom&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">listofxyz</span><span class="p">[</span><span class="s1">&#39;listofxyz&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])):</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">listofxyz</span><span class="p">[</span><span class="s1">&#39;listofxyz&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)])):</span>
                        <span class="n">atomtoatom</span><span class="p">[</span><span class="s1">&#39;atomtoatom&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">listofxyz</span><span class="p">[</span><span class="s1">&#39;listofxyz&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">listofxyz</span><span class="p">[</span><span class="s1">&#39;listofxyz&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)])[</span><span class="n">f</span><span class="p">]))</span>

    <span class="s2">&quot;Here we take the minimum distance between atoms between all AAs&quot;</span>
    <span class="n">minimumdistances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">j</span> <span class="ow">and</span> <span class="n">atomtoatom</span><span class="p">[</span><span class="s1">&#39;atomtoatom&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1">#New shit here...</span>
                <span class="n">minimumdistances</span><span class="p">[</span><span class="s1">&#39;minimumdistances&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">minimumdistances</span><span class="p">[</span><span class="s1">&#39;minimumdistances&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">atomtoatom</span><span class="p">[</span><span class="s1">&#39;atomtoatom&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)])</span>

    <span class="s2">&quot;Here we determine which pairs are close enough by setting an angstrom_distance constraint&quot;</span>
    <span class="n">closeatoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span><span class="o">&lt;</span><span class="n">j</span> <span class="ow">and</span> <span class="n">minimumdistances</span><span class="p">[</span><span class="s1">&#39;minimumdistances&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">(</span><span class="n">angstrom_distance</span><span class="p">)]):</span>
            <span class="c1">#if all([i&lt;j and minimumdistances[&#39;minimumdistances&#39;+str(i)+&#39;-&#39;+str(j)]&lt;float(angstrom_distance) and abs(i-j)!=1]):</span>
                <span class="n">closeatoms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>

    <span class="s2">&quot;Here we subtract of (1,1) from each pair to match the indecies of the regression format&quot;</span>  



    <span class="n">newcloseatoms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">closeatoms</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">newcloseatoms</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">newcloseatoms</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newcloseatoms</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">newcloseatoms</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="msm_design.msm_model.score_sequence_amber">
<code class="highlight language-python"><span class="n">score_sequence_amber</span><span class="p">(</span><span class="n">newseq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rosetta_path</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/source/bin/&#39;</span><span class="p">,</span> <span class="n">rosetta_db</span><span class="o">=</span><span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/database&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Provide rosetta path to fixbb.linuxgccrelease</p>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">score_sequence_amber</span><span class="p">(</span><span class="n">newseq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pdbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rosetta_path</span> <span class="o">=</span> <span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/source/bin/&#39;</span><span class="p">,</span><span class="n">rosetta_db</span> <span class="o">=</span> <span class="s1">&#39;/home/romeroroot/code/rosetta_src_2016.17.58663_bundle/main/database&#39;</span><span class="p">):</span>   
    <span class="s1">&#39;Provide rosetta path to fixbb.linuxgccrelease&#39;</span>
    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">remove</span>
    <span class="kn">import</span> <span class="nn">simtk.openmm.app</span> <span class="k">as</span> <span class="nn">app</span>
    <span class="kn">import</span> <span class="nn">simtk.openmm</span> <span class="k">as</span> <span class="nn">op</span>
    <span class="kn">import</span> <span class="nn">simtk.unit</span> <span class="k">as</span> <span class="nn">unit</span>

    <span class="k">def</span> <span class="nf">rand_tag</span><span class="p">():</span>
        <span class="sd">&#39;&#39;&#39;creates a unique tag that can be used to identify the current files a script is working with.  necessary for running the same program multiple times in the same directory&#39;&#39;&#39;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">choice</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">tag</span>



    <span class="k">def</span> <span class="nf">thread_repack_score_amber</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">newseq</span><span class="p">):</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="n">rand_tag</span><span class="p">()</span> <span class="c1"># generate a random tag to associate with this run</span>

        <span class="c1"># generate a resfile to mutate the pdb</span>
        <span class="n">resfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        #header</span>
<span class="s2">        NATAA # keep this so all sites aren&#39;t designed</span>
<span class="s2">        USE_INPUT_SC # this to also consider the WT rotamer, if we&#39;re mutating WT to WT</span>

<span class="s2">        start</span>

<span class="s2">        #body</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newseq</span><span class="p">)):</span>
            <span class="n">resfile</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">    A    PIKAA </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">newseq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;resfile_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;.res&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resfile</span><span class="p">)</span>


        <span class="c1"># the options for the run</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nice&#39;</span><span class="p">,</span>
                   <span class="n">rosetta_path</span><span class="o">+</span><span class="s1">&#39;fixbb.linuxgccrelease&#39;</span><span class="p">,</span> <span class="c1"># fixbb is the program used for threading a repacking</span>
                   <span class="s1">&#39;-s &#39;</span><span class="o">+</span><span class="n">pdbfile</span><span class="p">,</span> 
                   <span class="s1">&#39;-database &#39;</span><span class="o">+</span><span class="n">rosetta_db</span><span class="p">,</span> <span class="c1"># good to explicitly define location of rosetta DB</span>
                   <span class="s1">&#39;-resfile resfile_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;.res&#39;</span><span class="p">,</span> <span class="c1"># a resfile to specify mutations</span>
                   <span class="s1">&#39;-out:suffix _&#39;</span><span class="o">+</span><span class="n">tag</span><span class="p">]</span> <span class="c1"># this adds a suffix to the score output file: score_[RNDTAG].sc</span>

        <span class="c1"># run fixbb</span>
        <span class="n">Popen</span><span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="c1"># send stdout to the trash, report stderr</span>


        <span class="c1"># read the output</span>
        <span class="n">scorefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;score_</span><span class="si">%s</span><span class="s1">.sc&#39;</span><span class="o">%</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">scorefile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">scorefile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># use i-1 because the last entry is the filename</span>
        <span class="n">pdbname</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdbfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_0001.pdb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># now load into openMM and score with amber</span>
        <span class="n">pdb</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">PDBFile</span><span class="p">(</span><span class="n">pdbname</span><span class="p">)</span>
        <span class="n">forcefield</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">ForceField</span><span class="p">(</span><span class="s1">&#39;amber03.xml&#39;</span><span class="p">,</span><span class="s1">&#39;amber03_obc.xml&#39;</span><span class="p">)</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">LangevinIntegrator</span><span class="p">(</span><span class="mi">300</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span> <span class="mf">1e-9</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">picoseconds</span><span class="p">)</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>


        <span class="c1">#Must do try/except here because Amber occasionally throws an Exception error and does not return a score</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">()</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">kilojoule_per_mole</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="s1">&#39;Nan&#39;</span>
            <span class="k">pass</span>


        <span class="c1">#delete the evidence</span>
        <span class="n">remove</span><span class="p">(</span><span class="s1">&#39;score_</span><span class="si">%s</span><span class="s1">.sc&#39;</span><span class="o">%</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">remove</span><span class="p">(</span><span class="s1">&#39;resfile_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;.res&#39;</span><span class="p">)</span>
        <span class="n">remove</span><span class="p">(</span><span class="n">pdbname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">score</span>


    <span class="n">score</span> <span class="o">=</span> <span class="n">thread_repack_score_amber</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">newseq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="msm_design.msm_model.sigma2Phi">
<code class="highlight language-python"><span class="n">sigma2Phi</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">overall_solution_space</span><span class="p">,</span> <span class="n">reference_seq</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>This takes in an amino acid and a position and returns the 1x19 binary indicator vector Phi</p>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sigma2Phi</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This takes in an amino acid and a position and returns the 1x19 binary indicator vector Phi&quot;&quot;&quot;</span>
    <span class="n">AAchanges</span> <span class="o">=</span> <span class="p">[</span><span class="n">aa</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">overall_solution_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">aa</span><span class="o">!=</span><span class="n">reference_seq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="c1"># these are all 19 possible AA changes (i.e. AAs that are not the reference sequence AA)</span>
    <span class="c1">#AAchanges = [aa for aa in AAs if aa!=reference_seq[i]]</span>
    <span class="n">Phi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">AAchanges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sigma</span><span class="o">==</span><span class="n">aa</span><span class="p">:</span>
            <span class="n">Phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Phi</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="msm_design.msm_optimization">
        <code>msm_optimization</code>



</h2>

    <div class="doc doc-contents ">

      <p>Created on Wed Jan 18 23:26:11 2017</p>
<p>@author: Trent</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 class="doc doc-heading" id="msm_design.msm_optimization.Sequence_Optimization">
        <code>
Sequence_Optimization        </code>



</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>msm_design/msm_optimization.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Sequence_Optimization</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model_file_dir</span><span class="p">,</span><span class="n">wt_seq</span><span class="p">,</span><span class="n">sequence_alignment_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reduce_alignment</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mad_file_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cc_file_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">display_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pair_interaction_dist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pdb_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file_dir</span> <span class="o">=</span> <span class="n">model_file_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span> <span class="o">=</span> <span class="n">mad_file_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_file_dir</span> <span class="o">=</span> <span class="n">cc_file_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span> <span class="o">=</span> <span class="n">wt_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span> <span class="o">=</span> <span class="n">sequence_alignment_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="o">=</span> <span class="n">display_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span> <span class="o">=</span> <span class="n">reduce_alignment</span>
<span class="c1">#        if pair_interaction_dist and pdb_dir:</span>
<span class="c1">#            </span>
<span class="c1">#            pair_interaction_list=Msm_Design.pair_select(pdbfile,pair_interaction_dist,wt_seq)</span>
<span class="c1">#            self.pair_interaction_list = pair_interaction_list</span>

    <span class="k">def</span> <span class="nf">import_model_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">newfilelist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_dir</span><span class="p">)</span>

        <span class="n">newnamelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newnames</span> <span class="ow">in</span> <span class="n">newfilelist</span><span class="p">:</span>
            <span class="n">newnamelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">newnames</span><span class="p">))</span>

        <span class="n">wStates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newfilelist</span><span class="p">)):</span>
            <span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newnamelist</span><span class="p">[</span><span class="n">q</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newfilelist</span><span class="p">)):</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newfilelist</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">newtext</span> <span class="o">=</span> <span class="n">hh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">newtext</span> <span class="o">=</span> <span class="n">newtext</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">newtext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">newfloatedlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">numbers</span> <span class="ow">in</span> <span class="n">newtext</span><span class="p">:</span>
                <span class="n">newfloatedlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">numbers</span><span class="p">))</span>
            <span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newnamelist</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newfloatedlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wStates</span>



    <span class="k">def</span> <span class="nf">test_model_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span><span class="p">:</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span><span class="p">)</span>

            <span class="c1">#print filelist</span>

            <span class="n">namelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
                <span class="n">namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">names</span><span class="p">))</span>

            <span class="n">MADStates</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)):</span>
                <span class="n">MADStates</span><span class="p">[</span><span class="s1">&#39;MADState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">namelist</span><span class="p">[</span><span class="n">q</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[]</span>


            <span class="n">sumlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)):</span>
                <span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1">#text = pickle.load(open(&#39;seq_energies_state0_ubiquitin.p&#39;))</span>
                <span class="k">del</span> <span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">floatedlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">floatedlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="n">floatedlist</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">MADStates</span><span class="p">[</span><span class="s1">&#39;MADState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">namelist</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span> <span class="o">=</span> <span class="n">floatedlist</span>
                    <span class="n">thousandlist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">floatedlist</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">floatedlist</span><span class="p">)):</span>
                            <span class="n">thousandlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">floatedlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sumlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">thousandlist</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">thousandlist</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">floatedlist</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1000</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1001</span><span class="p">):</span>
                            <span class="n">thousandlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">floatedlist</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sumlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">thousandlist</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">])</span>
                <span class="n">sumlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sumlist</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sumlist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No MAD Directory Set&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_seq_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seq</span><span class="p">,</span><span class="n">state_number</span><span class="p">):</span>
        <span class="s1">&#39;Pair models not yet supported&#39;</span>
        <span class="n">wStates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">import_model_files</span><span class="p">()</span>
        <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">))</span>

        <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
        <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>        



        <span class="k">def</span> <span class="nf">binary_conversion</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)):</span>
                <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">sigma2Phi</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
            <span class="c1">#    for pair in position_pairs:</span>
            <span class="c1">#        firstpos = pair[0]</span>
            <span class="c1">#        secondpos = pair[1]</span>
            <span class="c1">#        pairs_j = pairs(lowESeqtest[n][firstpos],lowESeqtest[n][secondpos],firstpos,secondpos)</span>
            <span class="c1">#        seq_Phi.extend(pairs_j)</span>
            <span class="k">return</span> <span class="n">seq_Phi</span>



        <span class="n">rnd_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">seq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overall_solution_space</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Residue &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; at position &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; not in amino acid space &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">rnd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>                
                <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rnd_list</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>      
            <span class="n">binary_seq</span><span class="o">=</span><span class="n">binary_conversion</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary_seq</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_number</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">energy</span>

    <span class="k">def</span> <span class="nf">single_state_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">states_to_optimize_for_by_state_number</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mf">298.15</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mf">8.31447e-3</span><span class="p">,</span><span class="n">mut_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_mutation_pathway_passes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">inner_loop_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">mean_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_separate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_together</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pdf_output_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">write_opt_file_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s1">&#39;Pair distances not supported&#39;</span>


        <span class="n">mutation_threshold</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span><span class="o">-</span><span class="n">mut_thresh</span>




        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_model_performance</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">wStates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_model_files</span><span class="p">()</span>

        <span class="n">modelsfiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_dir</span><span class="p">)</span>

        <span class="n">modelsfilelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newnames</span> <span class="ow">in</span> <span class="n">modelsfiles</span><span class="p">:</span>
            <span class="n">modelsfilelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">newnames</span><span class="p">))</span>



        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span>        
        <span class="c1"># this is the amino acids allowed at each postion</span>

        <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">overall_solution_space</span>     <span class="p">)</span>
        <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
        <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>






        <span class="k">def</span> <span class="nf">binary_conversion</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
                <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">sigma2Phi</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
<span class="c1">#                for pair in position_pairs:</span>
<span class="c1">#                    firstpos = pair[0]</span>
<span class="c1">#                    secondpos = pair[1]</span>
<span class="c1">#                    pairs_j = pairs(sequence[n][firstpos],sequence[n][secondpos],firstpos,secondpos)</span>
<span class="c1">#                    seq_Phi.extend(pairs_j)</span>
            <span class="k">return</span> <span class="n">seq_Phi</span>






        <span class="k">def</span> <span class="nf">single_probability_estimation</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">State_to_optimize</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
                <span class="n">E_estimate</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">State_to_optimize</span><span class="p">)])</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">E_estimate</span>

        <span class="k">def</span> <span class="nf">multi_probability_estimation</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
            <span class="n">State_E_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;98&#39;</span> <span class="ow">and</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;45&#39;</span><span class="p">:</span>
                    <span class="n">E_estimate_mult</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">])])</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
                    <span class="n">State_E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_estimate_mult</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">State_E_list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">energy_mean_calc</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
            <span class="n">State_E_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;98&#39;</span> <span class="ow">and</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;45&#39;</span><span class="p">:</span>
                    <span class="n">E_mult</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">])])</span>
                    <span class="n">State_E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_mult</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">State_E_list</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">write_opt_file_name</span><span class="p">:</span>
            <span class="n">opt_filename</span> <span class="o">=</span> <span class="n">write_opt_file_name</span>

            <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Sequence&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chosen_state&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#state_opt = [&#39;State12&#39;]</span>

        <span class="c1">#Might need to take out WT mutations from overall_solution_space to avoid mutating to wt</span>
        <span class="n">best_seq_perstate_permutnum</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">pdf_output_plot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state_num</span> <span class="ow">in</span> <span class="n">states_to_optimize_for_by_state_number</span><span class="p">:</span>
            <span class="n">chosen_state</span> <span class="o">=</span> <span class="s1">&#39;State&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)</span>
            <span class="n">rand_seq_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">boltz_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">objective_func_sequence_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">muts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">mutation_threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">muts</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#Test Optimization </span>
            <span class="n">overall</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_mutation_pathway_passes</span><span class="p">):</span>
                <span class="n">trial</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inner_loop_trials</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">mut_thresh</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">aminoacidchain</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
                            <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">random_seq</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">mean_shift</span><span class="p">:</span>
                                <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">mean_energy</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">single_E</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">boltz_dist</span> <span class="o">=</span> <span class="n">single_E</span><span class="o">/</span><span class="n">multi_E</span>
                            <span class="n">boltz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                            <span class="n">Mut_num</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span>
                            <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Mut_num</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">boltz_dist</span><span class="p">,</span><span class="n">random_seq</span><span class="p">])</span>
                            <span class="n">trial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">randAAlist</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">randAAlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&gt;</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">mutantpositions</span> <span class="ow">in</span> <span class="n">randAAlist</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">])</span>
                            <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aachaintobemutated</span><span class="p">)</span>
                            <span class="n">listseq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">random_seq</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                                <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">mean_shift</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">single_E</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">boltz_dist</span> <span class="o">=</span> <span class="n">single_E</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&gt;</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listseq</span><span class="p">)</span>
                                <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">mean_shift</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">single_E</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">boltz_dist</span> <span class="o">=</span> <span class="n">single_E</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                                <span class="n">Mut_num</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span>

                                <span class="k">if</span> <span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="n">trial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                                    <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Mut_num</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">boltz_dist</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listseq</span><span class="p">)])</span>
                                    <span class="k">pass</span>
                                <span class="k">if</span> <span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="k">del</span> <span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">del</span> <span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>





                        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Mutation Pathway Number = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#This prints the current training set index on same line as an update</span>
                        <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">overall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">muts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">mutation_threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">muts</span><span class="p">)]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>





            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="ow">and</span> <span class="n">plot_separate</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">listt</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)])):</span>
                    <span class="n">listt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">probs</span><span class="o">=</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">probs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Single State Optimization for State &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>                
                    <span class="n">pp</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
                <span class="c1">#plt.show()                  </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>



            <span class="k">if</span> <span class="n">write_opt_file_name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)])):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;num_Mutations = &#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">best_results</span><span class="o">=</span><span class="n">best_seq_perstate_permutnum</span> 




        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="ow">and</span> <span class="n">plot_together</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="k">for</span> <span class="n">stuff</span> <span class="ow">in</span> <span class="n">best_seq_perstate_permutnum</span><span class="p">:</span>
                <span class="n">listt</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="n">stuff</span><span class="p">])):</span>
                    <span class="n">listt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="n">stuff</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">probs</span><span class="o">=</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log Shifted Probability Plot&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;For Most Probable Sequence Per State Per Mutation Number&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mutation Number&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Log of Probability&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">probs</span><span class="p">)</span>




        <span class="n">elapsedtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elapsedtime</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_seq_perstate_permutnum</span>



    <span class="k">def</span> <span class="nf">two_state_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">states_to_optimize_for_by_state_number</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mf">298.15</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mf">8.31447e-3</span><span class="p">,</span><span class="n">mut_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_mutation_pathway_passes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">inner_loop_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">mean_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_separate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_together</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pdf_output_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">write_opt_file_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>


        <span class="n">mutation_threshold</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span><span class="o">-</span><span class="n">mut_thresh</span>



        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_model_performance</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">wStates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_model_files</span><span class="p">()</span>

        <span class="n">modelsfiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_dir</span><span class="p">)</span>

        <span class="n">modelsfilelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newnames</span> <span class="ow">in</span> <span class="n">modelsfiles</span><span class="p">:</span>
            <span class="n">modelsfilelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">newnames</span><span class="p">))</span>



        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span>        
        <span class="c1"># this is the amino acids allowed at each postion</span>

        <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">))</span>

        <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
        <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>        





        <span class="k">def</span> <span class="nf">binary_conversion</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
                <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">sigma2Phi</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
            <span class="c1">#    for pair in position_pairs:</span>
            <span class="c1">#        firstpos = pair[0]</span>
            <span class="c1">#        secondpos = pair[1]</span>
            <span class="c1">#        pairs_j = pairs(lowESeqtest[n][firstpos],lowESeqtest[n][secondpos],firstpos,secondpos)</span>
            <span class="c1">#        seq_Phi.extend(pairs_j)</span>
            <span class="k">return</span> <span class="n">seq_Phi</span>






        <span class="k">def</span> <span class="nf">single_probability_estimation</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">State_to_optimize</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
                <span class="n">E_estimate</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">State_to_optimize</span><span class="p">)])</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">E_estimate</span>

        <span class="k">def</span> <span class="nf">multi_probability_estimation</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
            <span class="n">State_E_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;98&#39;</span> <span class="ow">and</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;45&#39;</span><span class="p">:</span>
                    <span class="n">E_estimate_mult</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">])])</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
                    <span class="n">State_E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_estimate_mult</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">State_E_list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">energy_mean_calc</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
            <span class="n">State_E_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;98&#39;</span> <span class="ow">and</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;45&#39;</span><span class="p">:</span>
                    <span class="n">E_mult</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">])])</span>
                    <span class="n">State_E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_mult</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">State_E_list</span><span class="p">)</span>





        <span class="k">if</span> <span class="n">write_opt_file_name</span><span class="p">:</span>
            <span class="n">opt_filename</span> <span class="o">=</span> <span class="n">write_opt_file_name</span>

            <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Objective_Function_Value&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Sequence&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chosen_state1&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chosen_state2&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


        <span class="n">best_seq_perstate_permutnum</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">pdf_output_plot</span><span class="p">)</span>
        <span class="c1">#Might need to take out WT mutations from overall_solution_space to avoid mutating to wt</span>
        <span class="c1">#Test Optimization</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">states_to_optimize_for_by_state_number</span><span class="p">)):</span>
            <span class="n">state_num1</span> <span class="o">=</span> <span class="n">states_to_optimize_for_by_state_number</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state_num2</span> <span class="o">=</span> <span class="n">states_to_optimize_for_by_state_number</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">chosen_state1</span> <span class="o">=</span> <span class="s1">&#39;State&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num1</span><span class="p">)</span>
            <span class="n">chosen_state2</span> <span class="o">=</span> <span class="s1">&#39;State&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)</span>
            <span class="n">two_state_opt_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">boltz_list1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">boltz_list2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rand_seq_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">objective_func_sequence_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">muts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">mutation_threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">muts</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">overall</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_mutation_pathway_passes</span><span class="p">):</span>
                <span class="n">trial</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inner_loop_trials</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">mut_thresh</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">aminoacidchain</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
                            <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">random_seq</span><span class="p">)</span>
                            <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                            <span class="n">single_E1</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state1</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">single_E2</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state2</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">boltz_dist1</span> <span class="o">=</span> <span class="n">single_E1</span><span class="o">/</span><span class="n">multi_E</span>
                            <span class="n">boltz_dist2</span> <span class="o">=</span> <span class="n">single_E2</span><span class="o">/</span><span class="n">multi_E</span>
                            <span class="n">boltz_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist1</span><span class="p">)</span>
                            <span class="n">boltz_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist2</span><span class="p">)</span>
                            <span class="n">opt_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">boltz_dist1</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">boltz_dist2</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                            <span class="n">two_state_opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_func</span><span class="p">)</span>
                            <span class="n">Mut_num</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span>
                            <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Mut_num</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">opt_func</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">),</span><span class="n">boltz_dist1</span><span class="p">,</span><span class="n">boltz_dist2</span><span class="p">])</span>
                            <span class="n">trial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_func</span><span class="p">)</span>                    
                        <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">randAAlist</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">randAAlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&gt;</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">mutantpositions</span> <span class="ow">in</span> <span class="n">randAAlist</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">])</span>
                            <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aachaintobemutated</span><span class="p">)</span>
                            <span class="n">listseq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">random_seq</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                                <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                                <span class="n">single_E1</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state1</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">single_E2</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state2</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">boltz_dist1</span> <span class="o">=</span> <span class="n">single_E1</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_dist2</span> <span class="o">=</span> <span class="n">single_E2</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist1</span><span class="p">)</span>
                                <span class="n">boltz_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist2</span><span class="p">)</span>
                                <span class="n">opt_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">boltz_dist1</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">boltz_dist2</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                                <span class="n">two_state_opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_func</span><span class="p">)</span> 
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&gt;</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listseq</span><span class="p">)</span>
                                <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                                <span class="n">single_E1</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state1</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">single_E2</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state2</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">boltz_dist1</span> <span class="o">=</span> <span class="n">single_E1</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_dist2</span> <span class="o">=</span> <span class="n">single_E2</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist1</span><span class="p">)</span>
                                <span class="n">boltz_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist2</span><span class="p">)</span>
                                <span class="n">opt_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">boltz_dist1</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">boltz_dist2</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                                <span class="n">two_state_opt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_func</span><span class="p">)</span>
                                <span class="n">Mut_num</span> <span class="o">=</span> <span class="mi">76</span><span class="o">-</span><span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="c1">#if two_state_opt_list[-1]&lt;=two_state_opt_list[-2]:</span>
                                    <span class="n">trial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_func</span><span class="p">)</span>
                                    <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Mut_num</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">opt_func</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listseq</span><span class="p">),</span><span class="n">boltz_dist1</span><span class="p">,</span><span class="n">boltz_dist2</span><span class="p">])</span>
                                    <span class="k">pass</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="c1">#if two_state_opt_list[-1]&gt;two_state_opt_list[-2]:                                </span>
                                    <span class="k">del</span> <span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">del</span> <span class="n">two_state_opt_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">del</span> <span class="n">boltz_list1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">del</span> <span class="n">boltz_list2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


                        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Mutation Pathway Number = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#This prints the current training set index on same line as an update</span>
                        <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">overall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">muts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">mutation_threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">muts</span><span class="p">)]))</span>



            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="ow">and</span> <span class="n">plot_separate</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">listt</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)])):</span>
                    <span class="n">listt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">probs</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">probs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Two State Optimization for State&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; and State&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num2</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mutation Number&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Objective Function Value&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>                
                    <span class="n">pp</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
                <span class="c1">#plt.show()                  </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>



            <span class="k">if</span> <span class="n">write_opt_file_name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)])):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_probability=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_probability=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state2</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;num_Mutations=&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="ow">and</span> <span class="n">plot_together</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="k">for</span> <span class="n">stuff</span> <span class="ow">in</span> <span class="n">best_seq_perstate_permutnum</span><span class="p">:</span>
                <span class="n">listt</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="n">stuff</span><span class="p">])):</span>
                    <span class="n">listt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="n">stuff</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">probs</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">probs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mutation Number&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Objective Function Value&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Two State Optimization for All Defined Pairs of States&#39;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">best_results</span><span class="o">=</span><span class="n">best_seq_perstate_permutnum</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>




        <span class="n">elapsedtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elapsedtime</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 class="doc doc-heading" id="msm_design.msm_optimization.Sequence_Optimization.generate_seq_energy">
<code class="highlight language-python"><span class="n">generate_seq_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">state_number</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Pair models not yet supported</p>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_optimization.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_seq_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seq</span><span class="p">,</span><span class="n">state_number</span><span class="p">):</span>
    <span class="s1">&#39;Pair models not yet supported&#39;</span>
    <span class="n">wStates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">import_model_files</span><span class="p">()</span>
    <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">))</span>

    <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
    <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
    <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>        



    <span class="k">def</span> <span class="nf">binary_conversion</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
        <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)):</span>
            <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">sigma2Phi</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
            <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
        <span class="c1">#    for pair in position_pairs:</span>
        <span class="c1">#        firstpos = pair[0]</span>
        <span class="c1">#        secondpos = pair[1]</span>
        <span class="c1">#        pairs_j = pairs(lowESeqtest[n][firstpos],lowESeqtest[n][secondpos],firstpos,secondpos)</span>
        <span class="c1">#        seq_Phi.extend(pairs_j)</span>
        <span class="k">return</span> <span class="n">seq_Phi</span>



    <span class="n">rnd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">seq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overall_solution_space</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Residue &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; at position &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; not in amino acid space &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">rnd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>                
            <span class="k">break</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rnd_list</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>      
        <span class="n">binary_seq</span><span class="o">=</span><span class="n">binary_conversion</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary_seq</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_number</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">energy</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h4 class="doc doc-heading" id="msm_design.msm_optimization.Sequence_Optimization.single_state_design">
<code class="highlight language-python"><span class="n">single_state_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states_to_optimize_for_by_state_number</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">298.15</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.00831447</span><span class="p">,</span> <span class="n">mut_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_mutation_pathway_passes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">inner_loop_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">mean_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_separate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_together</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pdf_output_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_opt_file_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Pair distances not supported</p>

        <details class="quote">
          <summary>Source code in <code>msm_design/msm_optimization.py</code></summary>
          <div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">single_state_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">states_to_optimize_for_by_state_number</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mf">298.15</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mf">8.31447e-3</span><span class="p">,</span><span class="n">mut_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_mutation_pathway_passes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">inner_loop_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">mean_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_separate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_together</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">pdf_output_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">write_opt_file_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s1">&#39;Pair distances not supported&#39;</span>


        <span class="n">mutation_threshold</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span><span class="o">-</span><span class="n">mut_thresh</span>




        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_file_dir</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_model_performance</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">wStates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_model_files</span><span class="p">()</span>

        <span class="n">modelsfiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_dir</span><span class="p">)</span>

        <span class="n">modelsfilelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newnames</span> <span class="ow">in</span> <span class="n">modelsfiles</span><span class="p">:</span>
            <span class="n">modelsfilelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">newnames</span><span class="p">))</span>



        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span><span class="p">)</span>        
        <span class="c1"># this is the amino acids allowed at each postion</span>

        <span class="n">overall_solution_space</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">import_sequence_alignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_alignment_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">reduce_alignment</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">overall_solution_space</span>     <span class="p">)</span>
        <span class="n">wildtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wt_seq</span>
        <span class="n">wtlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">wtlist</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>






        <span class="k">def</span> <span class="nf">binary_conversion</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">seq_Phi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
                <span class="n">Phi_i</span> <span class="o">=</span> <span class="n">msm_model</span><span class="o">.</span><span class="n">sigma2Phi</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">overall_solution_space</span><span class="p">,</span><span class="n">reference_seq</span><span class="p">)</span>
                <span class="n">seq_Phi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Phi_i</span><span class="p">)</span>
<span class="c1">#                for pair in position_pairs:</span>
<span class="c1">#                    firstpos = pair[0]</span>
<span class="c1">#                    secondpos = pair[1]</span>
<span class="c1">#                    pairs_j = pairs(sequence[n][firstpos],sequence[n][secondpos],firstpos,secondpos)</span>
<span class="c1">#                    seq_Phi.extend(pairs_j)</span>
            <span class="k">return</span> <span class="n">seq_Phi</span>






        <span class="k">def</span> <span class="nf">single_probability_estimation</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">State_to_optimize</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
                <span class="n">E_estimate</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">State_to_optimize</span><span class="p">)])</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">E_estimate</span>

        <span class="k">def</span> <span class="nf">multi_probability_estimation</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
            <span class="n">State_E_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;98&#39;</span> <span class="ow">and</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;45&#39;</span><span class="p">:</span>
                    <span class="n">E_estimate_mult</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">])])</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
                    <span class="n">State_E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_estimate_mult</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">State_E_list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">energy_mean_calc</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
            <span class="n">State_E_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;98&#39;</span> <span class="ow">and</span> <span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;45&#39;</span><span class="p">:</span>
                    <span class="n">E_mult</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">wStates</span><span class="p">[</span><span class="s1">&#39;wState&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelsfilelist</span><span class="p">[</span><span class="n">a</span><span class="p">])])</span>
                    <span class="n">State_E_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_mult</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">State_E_list</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">write_opt_file_name</span><span class="p">:</span>
            <span class="n">opt_filename</span> <span class="o">=</span> <span class="n">write_opt_file_name</span>

            <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Sequence&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chosen_state&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#state_opt = [&#39;State12&#39;]</span>

        <span class="c1">#Might need to take out WT mutations from overall_solution_space to avoid mutating to wt</span>
        <span class="n">best_seq_perstate_permutnum</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">pdf_output_plot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state_num</span> <span class="ow">in</span> <span class="n">states_to_optimize_for_by_state_number</span><span class="p">:</span>
            <span class="n">chosen_state</span> <span class="o">=</span> <span class="s1">&#39;State&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)</span>
            <span class="n">rand_seq_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">boltz_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">objective_func_sequence_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">muts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">mutation_threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">muts</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#Test Optimization </span>
            <span class="n">overall</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_mutation_pathway_passes</span><span class="p">):</span>
                <span class="n">trial</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inner_loop_trials</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">mut_thresh</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">aminoacidchain</span> <span class="o">=</span> <span class="p">[</span><span class="n">wildtype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">))]</span>
                            <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">random_seq</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">mean_shift</span><span class="p">:</span>
                                <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">mean_energy</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">single_E</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                            <span class="n">boltz_dist</span> <span class="o">=</span> <span class="n">single_E</span><span class="o">/</span><span class="n">multi_E</span>
                            <span class="n">boltz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                            <span class="n">Mut_num</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span>
                            <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Mut_num</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">boltz_dist</span><span class="p">,</span><span class="n">random_seq</span><span class="p">])</span>
                            <span class="n">trial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">randAAlist</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">randAAlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&gt;</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">mutantpositions</span> <span class="ow">in</span> <span class="n">randAAlist</span><span class="p">:</span>
                                <span class="n">aachaintobemutated</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">overall_solution_space</span><span class="p">[</span><span class="n">mutantpositions</span><span class="p">])</span>
                            <span class="n">random_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aachaintobemutated</span><span class="p">)</span>
                            <span class="n">listseq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">random_seq</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aminoacidchain</span><span class="p">)</span>
                                <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">mean_shift</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">single_E</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">boltz_dist</span> <span class="o">=</span> <span class="n">single_E</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span><span class="o">&gt;</span><span class="n">mutation_threshold</span><span class="p">:</span>
                                <span class="n">rand_seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listseq</span><span class="p">)</span>
                                <span class="n">Phi</span> <span class="o">=</span> <span class="n">binary_conversion</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">mean_shift</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">energy_mean_calc</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">mean_energy</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">single_E</span> <span class="o">=</span> <span class="n">single_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">chosen_state</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">multi_E</span> <span class="o">=</span> <span class="n">multi_probability_estimation</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">mean_energy</span><span class="p">)</span>
                                <span class="n">boltz_dist</span> <span class="o">=</span> <span class="n">single_E</span><span class="o">/</span><span class="n">multi_E</span>
                                <span class="n">boltz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                                <span class="n">Mut_num</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_seq</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">])</span>

                                <span class="k">if</span> <span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="n">trial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boltz_dist</span><span class="p">)</span>
                                    <span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Mut_num</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">boltz_dist</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listseq</span><span class="p">)])</span>
                                    <span class="k">pass</span>
                                <span class="k">if</span> <span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="k">del</span> <span class="n">rand_seq_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">del</span> <span class="n">boltz_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>





                        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Mutation Pathway Number = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#This prints the current training set index on same line as an update</span>
                        <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">overall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">muts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">mutation_threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">objective_func_sequence_dict</span><span class="p">[</span><span class="s1">&#39;Mutations_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">muts</span><span class="p">)]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>





            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="ow">and</span> <span class="n">plot_separate</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">listt</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)])):</span>
                    <span class="n">listt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">probs</span><span class="o">=</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">probs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Single State Optimization for State &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state_num</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>                
                    <span class="n">pp</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
                <span class="c1">#plt.show()                  </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>



            <span class="k">if</span> <span class="n">write_opt_file_name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)])):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">opt_filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chosen_state</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;num_Mutations = &#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf_output_plot</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">best_results</span><span class="o">=</span><span class="n">best_seq_perstate_permutnum</span> 




        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_plot</span> <span class="ow">and</span> <span class="n">plot_together</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="k">for</span> <span class="n">stuff</span> <span class="ow">in</span> <span class="n">best_seq_perstate_permutnum</span><span class="p">:</span>
                <span class="n">listt</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="n">stuff</span><span class="p">])):</span>
                    <span class="n">listt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">best_seq_perstate_permutnum</span><span class="p">[</span><span class="n">stuff</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">probs</span><span class="o">=</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listt</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log Shifted Probability Plot&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;For Most Probable Sequence Per State Per Mutation Number&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mutation Number&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Log of Probability&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">probs</span><span class="p">)</span>




        <span class="n">elapsedtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elapsedtime</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_seq_perstate_permutnum</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../about/" class="btn btn-neutral float-left" title="About"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../about/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
